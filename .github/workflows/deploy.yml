name: Deploy WebBiblioteca con Terraform

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Job 1: Construir y subir im√°genes Docker
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build y Push Backend
        run: |
          docker build -f backend/Dockerfile \
            -t ${{ secrets.DOCKER_USER }}/webbiblioteca-backend:latest \
            ./backend
          docker push ${{ secrets.DOCKER_USER }}/webbiblioteca-backend:latest

      - name: Build y Push Frontend
        run: |
          # Obtener la IP p√∫blica de la VM desde Terraform (si ya existe)
          PUBLIC_IP="${{ secrets.VM_PUBLIC_IP }}"
          
          docker build -f frontend/Dockerfile \
            --build-arg VITE_API_BASE_URL=http://${PUBLIC_IP}:5000/api \
            -t ${{ secrets.DOCKER_USER }}/webbiblioteca-frontend:latest \
            ./frontend
          docker push ${{ secrets.DOCKER_USER }}/webbiblioteca-frontend:latest

      - name: Docker Logout
        run: docker logout

  # Job 2: Desplegar infraestructura con Terraform
  terraform-deploy:
    name: Deploy VM with Terraform
    needs: build-and-push
    runs-on: ubuntu-latest
    outputs:
      vm_public_ip: ${{ steps.apply.outputs.public_ip }}
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.2
          terraform_wrapper: false

      - name: Crear archivo de clave privada OCI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: ./terraform
        env:
          TF_VAR_tenancy_ocid: ${{ secrets.TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.FINGERPRINT }}
          TF_VAR_private_key_path: ~/.oci/oci_api_key.pem
          TF_VAR_region: ${{ secrets.REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.COMPARTMENT_OCID }}
          TF_VAR_subnet_id: ${{ secrets.SUBNET_ID }}
          TF_VAR_availability_domain: ${{ secrets.AVAILABILITY_DOMAIN }}
          TF_VAR_ubuntu_image_ocid: ${{ secrets.UBUNTU_IMAGE_OCID }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_docker_user: ${{ secrets.DOCKER_USER }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_supa_anon_key: ${{ secrets.SUPA_ANON_KEY }}
          TF_VAR_supa_base_url: ${{ secrets.SUPA_BASE_URL }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        id: apply
        working-directory: ./terraform
        env:
          TF_VAR_tenancy_ocid: ${{ secrets.TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.FINGERPRINT }}
          TF_VAR_private_key_path: ~/.oci/oci_api_key.pem
          TF_VAR_region: ${{ secrets.REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.COMPARTMENT_OCID }}
          TF_VAR_subnet_id: ${{ secrets.SUBNET_ID }}
          TF_VAR_availability_domain: ${{ secrets.AVAILABILITY_DOMAIN }}
          TF_VAR_ubuntu_image_ocid: ${{ secrets.UBUNTU_IMAGE_OCID }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_docker_user: ${{ secrets.DOCKER_USER }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_supa_anon_key: ${{ secrets.SUPA_ANON_KEY }}
          TF_VAR_supa_base_url: ${{ secrets.SUPA_BASE_URL }}
        run: |
          terraform apply -auto-approve tfplan
          PUBLIC_IP=$(terraform output -raw public_ip)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT

      - name: Esperar a que cloud-init termine
        run: |
          echo "‚è≥ Esperando a que la VM termine la inicializaci√≥n con cloud-init..."
          VM_IP="${{ needs.terraform-deploy.outputs.vm_public_ip }}"
          
          # Crear clave SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Esperar a que SSH est√© disponible
          echo "üîå Esperando a que SSH est√© disponible..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ~/.ssh/id_ed25519 ubuntu@$VM_IP "echo 'SSH OK'" 2>/dev/null; then
              echo "‚úÖ SSH est√° disponible"
              break
            fi
            echo "Intento $i/30: SSH no disponible a√∫n..."
            sleep 10
          done
          
          # Esperar a que cloud-init termine completamente
          echo "‚è≥ Esperando a que cloud-init termine..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 ubuntu@$VM_IP << 'ENDSSH'
            set -e
            echo "Verificando estado de cloud-init..."
            
            # Esperar hasta 10 minutos (60 intentos x 10 segundos)
            for i in {1..60}; do
              if sudo cloud-init status --wait 2>/dev/null; then
                echo "‚úÖ cloud-init ha terminado"
                break
              fi
              echo "Intento $i/60: cloud-init a√∫n en progreso..."
              sleep 10
            done
            
            # Verificar que Docker est√© instalado
            if command -v docker &> /dev/null; then
              echo "‚úÖ Docker est√° instalado: $(docker --version)"
            else
              echo "‚ùå Docker no est√° instalado"
              exit 1
            fi
            
            # Verificar que el usuario tenga permisos de Docker
            if groups | grep -q docker; then
              echo "‚úÖ Usuario 'ubuntu' est√° en el grupo docker"
            else
              echo "‚ö†Ô∏è A√±adiendo usuario al grupo docker..."
              sudo usermod -aG docker ubuntu
            fi
            
            echo "‚úÖ VM lista para despliegue"

          
          echo "‚úÖ Inicializaci√≥n completada, procediendo con el despliegue..."

  # Job 3: Configurar y desplegar contenedores en la VM
  deploy-containers:
    name: Deploy Containers to VM
    needs: terraform-deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Crear clave SSH privada
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ needs.terraform-deploy.outputs.vm_public_ip }} >> ~/.ssh/known_hosts

      - name: Copiar archivos de despliegue a la VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ needs.terraform-deploy.outputs.vm_public_ip }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts/,docker-compose.yml"
          target: "/home/ubuntu/deploy"

      - name: Configurar Docker y desplegar contenedores
        uses: appleboy/ssh-action@master
        with:
          host: ${{ needs.terraform-deploy.outputs.vm_public_ip }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            DEPLOY_PATH="/home/ubuntu/deploy"
            cd $DEPLOY_PATH
            
            # Dar permisos de ejecuci√≥n a scripts
            chmod +x scripts/*.sh
            
            # Ejecutar setup de Docker (si no est√° instalado)
            echo "üê≥ Verificando instalaci√≥n de Docker..."
            if ! command -v docker &> /dev/null; then
                sudo $DEPLOY_PATH/scripts/setup_docker.sh
            fi
            
            # Esperar a que Docker est√© completamente listo
            echo "‚è≥ Esperando a que Docker est√© listo..."
            sleep 10
            
            # Crear archivo .env
            cat > $DEPLOY_PATH/.env << EOF
            DOCKER_USER=${{ secrets.DOCKER_USER }}
            PORT=5000
            NODE_ENV=production
            FRONTEND_URL=http://${{ needs.terraform-deploy.outputs.vm_public_ip }}
            SUPA_BASE_URL=${{ secrets.SUPA_BASE_URL }}
            SUPA_ANON_KEY=${{ secrets.SUPA_ANON_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EOF
            
            # Login a Docker Hub
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin
            
            # Detener contenedores existentes
            echo "üõë Deteniendo contenedores existentes..."
            sudo docker compose -f $DEPLOY_PATH/docker-compose.yml down || true
            
            # Pull de im√°genes actualizadas
            echo "üì• Descargando im√°genes actualizadas..."
            sudo docker compose -f $DEPLOY_PATH/docker-compose.yml pull
            
            # Iniciar contenedores
            echo "üöÄ Iniciando contenedores..."
            sudo docker compose -f $DEPLOY_PATH/docker-compose.yml up -d --force-recreate
            
            # Logout de Docker
            sudo docker logout
            
            # Esperar a que los contenedores inicien
            echo "‚è≥ Esperando 20 segundos para que los servicios inicien..."
            sleep 20
            
            # Ejecutar script de verificaci√≥n
            echo "üîç Verificando estado de los servicios..."
            $DEPLOY_PATH/scripts/check_health.sh

      - name: Notificar despliegue exitoso por email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ WebBiblioteca desplegada exitosamente"
          body: |
            üéâ La aplicaci√≥n WebBiblioteca ha sido desplegada exitosamente!
            
            üìç Acceso a los servicios:
            - Frontend: http://${{ needs.terraform-deploy.outputs.vm_public_ip }}
            - Backend API: http://${{ needs.terraform-deploy.outputs.vm_public_ip }}:5000/api
            
            üîß Commit: ${{ github.sha }}
            üë§ Por: ${{ github.actor }}
          to: molinafranz943@gmail.com
          from: ${{ secrets.EMAIL_USER }}

      - name: Notificar fallo por email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Error en despliegue de WebBiblioteca"
          body: |
            ‚ùå El despliegue de WebBiblioteca ha fallado.
            
            Por favor revisa los logs en GitHub Actions:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: molinafranz943@gmail.com
          from: ${{ secrets.EMAIL_USER }}